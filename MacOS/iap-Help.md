# In App Purchase Help

>  因内购在开发阶段和发布后存在很大的差别，为了更好的测试此功能，所以撰写此说明文档

[toc]

## 功能性说明

1. Filmora8验证（选择路径）功能：你可以选择一个从AppStore购买安装的`Filmora8`版本进行验证，如果验证成功，将给解锁相关内购功能，Demo中操操作日志结果为准；
2. 模式选择：
   1. 常规模式：会自动进行下一步相关操作：点击购买 > 获取商品 > 购买 > 验证 > 购买完成；
   2. 调试模式：将需要手动一步步进行操作：点击获取 > 点击购买 > 点击验证 > 购买完成；
   3. 调试模式主要方便开发的时候一步步调试，能够显示出更多的操作日志，无其它区别。
3. 购买时间、过期时间：
   1. 默认状态为：unknown，表示用户从没有买过（包括购买后退订）；
   2. 购买时间：如果购买过多次：
      1. 订阅型商品则展示最后一次的购买时间；
      2. 非消耗型则正常展示。
   3. 过期时间：时间与当前时间对比，小于当前时间则过期；
4. RestorePurchases：恢复购买，针对你买过对应的商品，但由于你换设备或卸载App重装后，给用户恢复之前购买过的商品；
5. Copy：用于复制操作日志，如出现问题时，可将操作日志复制给开发人员，便于快速定位问题



## Testing In-App Purchases - 测试应用内购买

1. 创建沙盒测试账号：登录 [appstoreconnect](https://appstoreconnect.apple.com/) 选择用户与职能，找到管理按钮，然后进行创建，创建时所用的邮箱可以随便写，只要格式符合邮箱格式就可以；

2. 退出Mac AppStore 已经登录的AppleID；

3. 运行你自己的内购APP，进行内购测试；

4. 购买时会让你先登录到AppStore，这时输入刚创建的沙盒测试账号；

5. 注意项：

   1. 不能使用正常的AppleID进行内购测试；

   2. 沙盒测试账号无法通过appStore进行查看具体订阅情况；

   3. 沙盒测试账号无法主动退订订阅；

   4. 沙盒账号测试时，针对订阅型商品：会在你主动订阅后自动续订6期，6次后自动退订，然后又需要手动订阅，依此方式循环下去

   5. macOS下无法使用`testflight`进行测试，`testflight`只适用于：iPhone，iPad， iPod

   6. 沙盒测试环境下订阅时效问题：

      在我们测试自动续期订阅时，时限会缩短，如下表：

## 开发测试阶段订阅时效对照表

在开发阶段自动续期订阅时，时限会缩短。此外，订阅型商品最多仅能自动续期 **6** 次。

| 实际时限 | 测试时限 |
| :------: | :------: |
|   1 周   |  3 分钟  |
|  1个月   |  5 分钟  |
|  2 个月  | 10 分钟  |
|  3 个月  | 15 分钟  |
|  6 个月  | 30 分钟  |
|   1 年   |  1 小时  |



## 大概流程图：

1. 目前我们App走的是***客户端独立验证流程***

![内购流程大纲](https://blog-1257063273.cos.ap-chengdu.myqcloud.com/InAppPurchaseFlow.png)

