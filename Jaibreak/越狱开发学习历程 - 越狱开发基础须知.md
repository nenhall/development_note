越狱开发学习历程 - 越狱开发基础须知

[TOC]



# 越狱开发学习历程:越狱开发基础须知

## Mach-O的认识：

1. Mach-O文件的认识：Mach-O是Mach object的缩写，是mac/ios上用天存储程序、库的标准格式.
2. Mach-O格式的文件类型有11种，具体可在[xnu](https://opensource.apple.com/tarballs/xnu/)源码中查到：xnu是指mac系统的内核，下载xun的源码后，进入文件后在`EXTERNAL_HEADERS->mach-o->loader.h`文件，大概110行左右，有mach-o文件类型的介绍。
3. 常用的Mach-O文件类型：
    * MH_OBJECT:
        * 目标文件(.o) `备注：.c生成 > .o生成 > 通一个链接的操作生成可执行文件`；
        * 静态库文件(.a)，静态库其实不是N个.o文件合并在一起的；
        * 验证文件类型的方法：
            1. 先创建一个.c文件；
            2. 通过终端将.c文件编译成.O文件，命令：`clang -c 文件名.c`；
            3. 查看生成新生成的.o文件类型：`file 文件名.o`，会打印如下信息`文件名.o：Mach-o 64-bit object x86_64`,说明综即是一个Mach-O文件，查看.a文件也是一样的方法。

    * MH_EXECUTE：可执行文件
    * MH_DYLIB：动态库文件：`.dylib` `.framework/xx`
    * MH_DYLINKER：动态链接编辑器，如下面会讲到的,手机内的`dyld`文件，位置：`Device->usr->lib->dyld`
    * MH_DSYM：存储着二进制文件符号信息的文件，如ipa的符号信息表(.dSYM)。


## 常用的越狱开发工具：

### 砸壳工具

#### [Clutch](https://github.com/KJCracks/Clutch.git) 砸壳

1. 先下载clutch代码到电脑，编译后得到`Clutch`可执行文件；

2. 把`Clutch`可执行文件放到越狱的手机的`Device->usr->bin`目录下；

3. 登录到你的手机，进入到`Device->usr->bin`目录下，执行：Clutch，会显示Clutch的命令代号；

4. 查看你手机中加密的应用，执行：`Clutch -i`，会打印如下类信息。

5. 如果报没有执行权限，执行命令：`chmod +x /usr/bin/Clutch`

    ```
    iPad:~ root# Clutch -i
    2018-04-07 20:45:45.222 Clutch[2769:117785] command: Prints installed applications
    Installed apps:
    1: 百度网盘 HD <com.baidu.netdisk-iPad>
    2: 闪电VPN-这是一款VPN高效网络加速神器 <com.yang.vpni3>
    3: 腾讯课堂-专业的直播学习平台 <com.tencent.edu>
    4: QQ HD <com.tencent.mipadqq>
    5: QQ音乐HD <com.tencent.QQMusicHD>
    6: 搜狗输入法-语音输入文字扫描 <com.sogou.sogouinput>
    7: 王者荣耀 <com.tencent.smoba>
    ```

6. 对某个app进行砸壳：`Clutch -d 4`，命令说明4对应上面的4，即第四个app(QQ HD)，砸壳需要耗时，完成后终端会打印砸壳完后的ipa包路径，如下成功示例，有些app做了反砸壳的处理，可能会失败：

    ```
     iPad:~ root# Clutch -d 4
      2018-04-07 15:18:21.481 Clutch[2426:68416] command: Dump specified bundleID into .ipa file
      Zipping IPadQQ.app
      Swapping architectures..
      Dumping <IPadQQ> (armv7)
      Patched cryptid (32bit segment)
      Writing new checksum
      Dumping <IPadQQ> (arm64)
      Patched cryptid (64bit segment)
      Writing new checksum
      ^[[CDONE: /private/var/mobile/Documents/Dumped/com.tencent.mipadqq-iOS7.0-(Clutch-(null)).ipa
      Finished dumping com.tencent.mipadqq in 869.8 seconds
      Connection to localhost closed by remote host.
      Connection to localhost closed.
    ```



6. 砸壳完的ipa文件它会存放在：

    > 位置一：`Device->private->var->mobile->Documents->Dumped`。

    > 位置二，其实这里也可以找到：`Device->User->Documents->Dumped`；

7. 查看ipa包是不是加密(砸壳):`otool -l /Users/nh/Desktop/QQ_7.5.5/QQ(可执行文件的路径) | grep crypt`，我这里查看的是QQ，正常情况下填的应该是QQ可执行文件所在的路径，如下。

    ```
    iMac:~ nh$ otool -l /Users/nh/Desktop/QQ_7.5.5/QQ | grep crypt
         cryptoff 16384
        cryptsize 16384
          cryptid 1 （这里的1代表32位的已砸壳，0则相反）
         cryptoff 16384
        cryptsize 16384
          cryptid 1 （这里的1代表64位的已砸壳，0则相反）
    ```


#### [dumpdecrypted](https://github.com/stefanesser/dumpdecrypted) 砸壳，可以自己去官网看使用教程，Clutch比较方便点

1. 砸壳后的文件会存放在与`dumpdecrypted.dylib `同等级目录下
2. 将编译得到的`dumpdecrypted.dylib`文件拷贝到手机的root目录下
3. 如果报没有执行权限，执行命令：`chmod +x dumpdecrypted.dylib`

	 ```
	 Usage:
	
	 iPod:~ root# DYLD_INSERT_LIBRARIES=dumpdecrypted.dylib /var/mobile/Applications/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/Scan.app/Scan
	 ```

* 常见错误：

  ```
  dyld: could not load inserted library 'dumpdecrypted.dylib' because no suitable image found. Did find:
  
  dumpdecrypted.dylib: required code signature missing for 'dumpdecrypted.dylib'
  ```

  **解决办法：**

  ```
  列出可签名证书
  security find-identity -v -p codesigning
  为dumpecrypted.dylib签名
  codesign --force --verify --verbose --sign "iPhone Developer: xxx xxxx (xxxxxxxxxx)" 
  ```

查找app的路径：`find / -name xxxx.app`



### theos

#### mac shell命令说明:

1. /usr/bin/主要是系统的命令集；

2. /usr/local/bin/系统的和第三方软件的，我们自己新建的shell命令建议放到这个目录下；

3. 当然不止上面两个路径，有时安装第三方软件或者命令行工具会自动创建，只是上面两个是mac系统本身就有的；



#### .bash_profile文件配置说明：

1. 当我们在终端执行某命令时，系统是通过`.bash_profile`配置好的环境变量路径中去找，如果找不到就会报`xx command not found: xxx`，

2. 添加环境变量：`vim .bash_profile` ，如我要添加一个`~/theos`的环境变量:
	```
    //.bash_profile中原有的内容不变,在最后添加如下代码即可
    export THEOS=~/theos
    export PATH=$THEOS/bin:$PATH
	```

    释义：
  
    > 1. export THEOS=~/theos：需要导出一个环境变量，环境变量的名称：THEOS，环境变量的值(路径)是~/theos
  
    > 2. export PATH=\$THEOS/bin:\$PATH：展开的写法：`export PATH=~/theos/bin`
  
    > 3. 但因上面已添加了一个环境变量叫:THEOS，所以可以直接写成`$THEOS/bin`，有多个环境变量时，用`:`隔开，如：`export PATH=~/theos/bin:/usr/bin:/usr/local/bin`
  
    > 4. 最后的`$PATH`代表引用之前配置好的环境变量，因为你不知道之前有几个这种环境变量，所以最后加上`$PATH`，这样的话不会导致之前设的环境变量失效.



#### 配置

1. 下载：`git clone --recursive https://github.com/theos/theos.git ~/theos`，

    不要直接使用下载，因为这个项目有依懒其它项目，如果直接下载则无法下载到依懒项目，所以使用命令行`git clone --recursive`，

    ~/theos代表下载到当前用户的`theos`文件夹下。

2. 配置环境变量：:`cd` > `vim .bash_profile` > 添加如下代码

    ```
    //.bash_profile中原有的内容不变,在最后添加如下代码
    export THEOS=~/theos
    export PATH=$THEOS/bin:$PATH
    ```

3. 配置好后，执行`source .bash_profile`，更新配置文件，不执行这句新添加的环境变量将不无法加载。

4. theos资料查询

    目录结构：https://github.com/theos/theos/wiki/Structure

    环境变量：http://iphonedevwiki.net/index.php/Theos 

    Logos语法: http://iphonedevwiki.net/index.php/Logos

    * %hook、%end：hook一个类的开始和结束

    * %log：打印方法调用详情

     * 可以通过 Xcode-> Window-> Devices and simulators查看日志

    * Hbdebuglog：跟 Slog类似

    * %neW：添加一个新的方法

    * %c( classname)：生成一个Cass对象，比如%c( Nsobject)，类似于

    Nsstring Fromclasso, objc_getclasso

    * %orig：函数原来的代码逻辑

    * %ctor：在加载动态库时调用   

    [theos常见错误](https://www.jianshu.com/p/262baa57c1cf)



### 还原伪代码

#### [Hopper Disassembler](https://www.hopperapp.com)

把砸壳后的可执行文件拖入Hopper Disassembler app内，可执行文件越大，则解析的耗时越久，在解析的过程中可能比较卡，app导航栏下面有颜色且断断续续的就是代表进度，具体Hopper Disassembler的使用，自行百度吧！



### 其它知识点补充：

#### OC对象的本质：

1. NSObject在内存其它就是一个结构体

2. 结构体指针在64位系统上占8个字节,32位上占4个字节

3. NSObject实例化后所占用的内存为16个字节，你可能会觉得与第2点冲突，其实，还有8个字节是预留用的。



#### iOS系统动态库的可执行文件存放位置：

1. 从iOS3.0开始，苹果使用的是缓存共享策略方式：

    * 可执行文件存放的位置：`Device->System->Library->Caches->com.apple.dyld`

    * 库的头文件描述信息不变：`Device->System->Library->Frameworks`

    * 动态库的加载方式：依靠**dyld**这个程序来加载相应的动态库的可执行文件，位置：`Device->usr->lib->dyld`。





